"use strict";(self["webpackChunkvue_logistics_system"]=self["webpackChunkvue_logistics_system"]||[]).push([[7642],{7642:(e,l,a)=>{a.r(l),a.d(l,{default:()=>O});var o=a(641),t=a(33),n=a(953),r=a(7918),i=a(163),u=a(8548),d=a(1303);const c={class:"field-rule-config-container"},p={class:"card-header"},s={class:"rule-logic-group"},b={key:0,class:"connector-selector"},m={class:"condition-item"},v={key:0,class:"rule-logic-builder"},f={key:1,class:"rule-logic-builder"},g=["innerHTML"],k={style:{color:"red","font-weight":"bold"}},y={__name:"FieldRuleConfig",setup(e){const l=(0,n.KR)(null),a=(0,n.KR)(!1),y=(0,n.KR)(null),h=(0,n.KR)(!1),_=(0,n.KR)(!1),O=(e="comparison",l="AND")=>{const a={id:(0,d.A)(),type:e,connector:l};return"comparison"===e?{...a,leftOperand:{field:null},operator:null,rightOperand:{type:"constant",value:null}}:"calculation"===e?{...a,fieldA:null,calcOperator:"-",fieldB:null,comparisonOperator:null,constantValue:null}:a},V=()=>({id:null,name:"",description:"",sourceTable:null,deductionPoints:0,logic:{conditions:[O("comparison")]}}),F=(0,n.Kh)(V()),w=(0,n.Kh)({name:[{required:!0,message:"请输入规则名称",trigger:"blur"}],sourceTable:[{required:!0,message:"请选择数据来源表",trigger:"change"}],deductionPoints:[{required:!0,message:"请输入扣分分值",trigger:"blur"},{type:"number",message:"扣分分值必须为数字"},{validator:(e,l,a)=>{l<0?a(new Error("扣分分值不能为负数")):a()},trigger:"blur"}]}),A=(0,n.KR)([]),C=(0,n.KR)([]),U=(0,n.KR)({}),T=(0,n.KR)([{value:">=",label:">="},{value:"<=",label:"<="},{value:">",label:">"},{value:"<",label:"<"},{value:"==",label:"=="},{value:"!=",label:"!="},{value:"is_empty",label:"为空"},{value:"is_not_empty",label:"不为空"},{value:"earlier_than",label:"早于"},{value:"later_than",label:"晚于"}]),$=(0,n.KR)([{value:">=",label:">="},{value:"<=",label:"<="},{value:">",label:">"},{value:"<",label:"<"},{value:"==",label:"=="},{value:"!=",label:"!="}]),X=["is_empty","is_not_empty"];(0,o.sV)((async()=>{await x(),await K()}));const x=async()=>{await new Promise((e=>setTimeout(e,100))),C.value=[{value:"order",label:"订单表 (order)"},{value:"cargo_damage",label:"货损记录表 (cargo_damage)"}],U.value={order:[{value:"planned_pickup_time",label:"计划提货时间",type:"datetime"},{value:"actual_pickup_time",label:"实际提货时间",type:"datetime"},{value:"pickup_duration",label:"提货用时(小时)",type:"number"},{value:"order_amount",label:"订单金额",type:"number"},{value:"remarks",label:"备注",type:"string"}],cargo_damage:[{value:"damage_amount",label:"货损金额",type:"number"},{value:"compensation_amount",label:"赔偿金额",type:"number"},{value:"is_compensated",label:"是否赔付",type:"boolean"}]}},K=async()=>{_.value=!0,await new Promise((e=>setTimeout(e,500))),A.value=[{id:"rule_1",name:"实际提货晚点",description:"",sourceTable:"order",deductionPoints:5,logic:{conditions:[{id:(0,d.A)(),type:"comparison",connector:"AND",leftOperand:{field:"actual_pickup_time"},operator:"later_than",rightOperand:{type:"field",value:"planned_pickup_time"}}]}},{id:"rule_mixed",name:"提货晚点 且 (金额>5000 或 备注为空)",description:"",sourceTable:"order",deductionPoints:10,logic:{conditions:[{id:(0,d.A)(),type:"comparison",connector:"AND",leftOperand:{field:"actual_pickup_time"},operator:"later_than",rightOperand:{type:"field",value:"planned_pickup_time"}},{id:(0,d.A)(),type:"comparison",connector:"OR",leftOperand:{field:"order_amount"},operator:">",rightOperand:{type:"constant",value:"5000"}},{id:(0,d.A)(),type:"comparison",connector:"AND",leftOperand:{field:"remarks"},operator:"is_empty",rightOperand:{type:"constant",value:null}}]}},{id:"rule_calc_or",name:"货损金额>1000 或 赔偿金额>500",description:"",sourceTable:"cargo_damage",deductionPoints:15,logic:{conditions:[{id:(0,d.A)(),type:"comparison",connector:"OR",leftOperand:{field:"damage_amount"},operator:">",rightOperand:{type:"constant",value:"1000"}},{id:(0,d.A)(),type:"comparison",connector:"AND",leftOperand:{field:"compensation_amount"},operator:">",rightOperand:{type:"constant",value:"500"}}]}}],_.value=!1},R=e=>e&&U.value[e]?U.value[e]:[],W=e=>{const l=R(e);return l.filter((e=>["number","datetime"].includes(e.type)))},N=(e,l)=>{const a=R(e),o=a.find((e=>e.value===l));return o?o.label:l},E=e=>X.includes(e),z=(e,l)=>{let a="";if(!e)return"(无效条件)";if("comparison"===e.type){if(!e.leftOperand||!e.leftOperand.field||!e.operator)return"(无效字段比较)";const o=N(l,e.leftOperand.field),t=T.value.find((l=>l.value===e.operator))?.label||e.operator;if(a=`[${o}] ${t}`,!E(e.operator))if(e.rightOperand)if("field"===e.rightOperand.type){const o=N(l,e.rightOperand.value);a+=` [${o||"未选字段"}]`}else"constant"===e.rightOperand.type&&(a+=` "${e.rightOperand.value||""}"`);else a+=" [未配置]"}else if("calculation"===e.type){if(!e.fieldA||!e.calcOperator||!e.fieldB||!e.comparisonOperator)return"(无效计算比较)";const o=N(l,e.fieldA),t=N(l,e.fieldB),n=$.value.find((l=>l.value===e.comparisonOperator))?.label||e.comparisonOperator;a=`([${o}] ${e.calcOperator} [${t}]) ${n} "${e.constantValue||""}"`}else a=`未知条件类型: ${e.type}`;return`(${a})`},P=(e,l)=>{if(!e||!e.conditions||0===e.conditions.length)return"未配置逻辑";let a="";return e.conditions.forEach(((o,t)=>{const n=z(o,l);if(0===t)a+=n;else{const l=e.conditions[t-1]?.connector||"AND",o="OR"===l?' <span style="color: orange; font-weight: bold;">OR</span> ':' <span style="color: blue; font-weight: bold;">AND</span> ';a+=o+n}})),a},D=()=>{F.logic.conditions.forEach((e=>{"comparison"===e.type?(e.leftOperand.field=null,"field"===e.rightOperand.type&&(e.rightOperand.value=null)):"calculation"===e.type&&(e.fieldA=null,e.fieldB=null)})),l.value?.clearValidate()},B=()=>{F.logic.conditions.push(O("comparison","AND"))},I=e=>{F.logic.conditions.length>1&&F.logic.conditions.splice(e,1)},L=()=>{const e=V();Object.assign(F,JSON.parse(JSON.stringify(e))),a.value=!1,y.value=null,(0,o.dY)((()=>{l.value?.clearValidate()}))},J=()=>{L()},S=e=>{a.value=!0,y.value=e.id;const t=V(),n={...t,...JSON.parse(JSON.stringify(e))};Object.assign(F,n),F.logic&&F.logic.conditions&&F.logic.conditions.forEach((e=>{e.id||(e.id=(0,d.A)()),void 0===e.connector&&(e.connector="AND")})),(0,o.dY)((()=>{l.value?.clearValidate()}))},Q=e=>{r.s.confirm("确定要删除这条规则吗？此操作不可撤销。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{console.log("删除规则 ID:",e),h.value=!0,await new Promise((e=>setTimeout(e,300))),h.value=!1,i.nk.success("规则删除成功"),K(),a.value&&y.value===e&&L()})).catch((()=>{}))},q=(e,l)=>{const a=`条件 #${l+1}: `;if(!e.type)return i.nk.error(`${a}请选择条件类型`),!1;if("comparison"===e.type){if(!e.leftOperand||!e.leftOperand.field)return i.nk.error(`${a}请选择左侧字段`),!1;if(!e.operator)return i.nk.error(`${a}请选择比较符`),!1;if(!E(e.operator)){if(!e.rightOperand||!e.rightOperand.type)return i.nk.error(`${a}请选择右侧操作数类型`),!1;if(null===e.rightOperand.value||void 0===e.rightOperand.value||""===e.rightOperand.value){const l="field"===e.rightOperand.type?"请选择右侧字段":"请输入右侧常量值";return i.nk.error(`${a}${l}`),!1}}}else{if("calculation"!==e.type)return i.nk.error(`${a}未知的条件类型`),!1;if(!e.fieldA)return i.nk.error(`${a}请选择计算字段A`),!1;if(!e.calcOperator)return i.nk.error(`${a}请选择算术运算符`),!1;if(!e.fieldB)return i.nk.error(`${a}请选择计算字段B`),!1;if(!e.comparisonOperator)return i.nk.error(`${a}请选择比较运算符`),!1;if(null===e.constantValue||void 0===e.constantValue||""===e.constantValue)return i.nk.error(`${a}请输入常量值`),!1}return!(l<F.logic.conditions.length-1&&!e.connector)||(i.nk.error(`${a}请为该条件选择一个连接到下一条件的运算符 (AND/OR)`),!1)},j=()=>{l.value?.validate((async e=>{if(!e)return i.nk.error("表单验证失败，请检查输入项。"),!1;{if(!F.logic.conditions||0===F.logic.conditions.length)return void i.nk.error("请至少配置一个规则条件");let e=!0;for(let l=0;l<F.logic.conditions.length;l++)if(!q(F.logic.conditions[l],l)){e=!1;break}if(!e)return;h.value=!0;try{const e=JSON.parse(JSON.stringify(F));e.logic&&e.logic.conditions&&e.logic.conditions.length>0&&delete e.logic.conditions[e.logic.conditions.length-1].connector,a.value?(console.log("更新规则:",e),await new Promise((e=>setTimeout(e,500))),i.nk.success("规则更新成功")):(e.id=`rule_${(0,d.A)()}`,console.log("创建规则:",e),await new Promise((e=>setTimeout(e,500))),i.nk.success("规则创建成功")),L(),K()}catch(l){console.error("保存规则失败:",l),i.nk.error("保存规则失败，请稍后重试。")}finally{h.value=!1}}}))};return(e,r)=>{const i=(0,o.g2)("el-button"),d=(0,o.g2)("el-input"),y=(0,o.g2)("el-form-item"),O=(0,o.g2)("el-option"),V=(0,o.g2)("el-select"),U=(0,o.g2)("el-radio-button"),X=(0,o.g2)("el-radio-group"),x=(0,o.g2)("el-col"),K=(0,o.g2)("el-row"),N=(0,o.g2)("el-input-number"),z=(0,o.g2)("el-form"),q=(0,o.g2)("el-card"),H=(0,o.g2)("el-table-column"),M=(0,o.g2)("el-table"),Y=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",c,[(0,o.bF)(K,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(x,{span:10},{default:(0,o.k6)((()=>[(0,o.bF)(q,null,{header:(0,o.k6)((()=>[(0,o.Lk)("div",p,[(0,o.Lk)("span",null,(0,t.v_)(a.value?"编辑字段规则":"创建新字段规则"),1),a.value?((0,o.uX)(),(0,o.Wv)(i,{key:0,type:"text",onClick:J},{default:(0,o.k6)((()=>r[4]||(r[4]=[(0,o.eW)("取消编辑")]))),_:1})):(0,o.Q3)("",!0)])])),default:(0,o.k6)((()=>[(0,o.bF)(z,{model:F,ref_key:"ruleFormRef",ref:l,rules:w,"label-width":"120px","label-position":"top"},{default:(0,o.k6)((()=>[(0,o.bF)(y,{label:"规则名称",prop:"name"},{default:(0,o.k6)((()=>[(0,o.bF)(d,{modelValue:F.name,"onUpdate:modelValue":r[0]||(r[0]=e=>F.name=e),placeholder:"例如：提货晚点或金额超限"},null,8,["modelValue"])])),_:1}),(0,o.bF)(y,{label:"数据来源表",prop:"sourceTable"},{default:(0,o.k6)((()=>[(0,o.bF)(V,{modelValue:F.sourceTable,"onUpdate:modelValue":r[1]||(r[1]=e=>F.sourceTable=e),placeholder:"选择数据表",clearable:"",onChange:D},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(C.value,(e=>((0,o.uX)(),(0,o.Wv)(O,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(y,{label:"规则逻辑",prop:"logic.conditions"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",s,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(F.logic.conditions,((e,l)=>((0,o.uX)(),(0,o.CE)("div",{key:e.id||l},[l>0?((0,o.uX)(),(0,o.CE)("div",b,[(0,o.bF)(X,{modelValue:e.connector,"onUpdate:modelValue":l=>e.connector=l,size:"small"},{default:(0,o.k6)((()=>[(0,o.bF)(U,{label:"AND"},{default:(0,o.k6)((()=>r[5]||(r[5]=[(0,o.eW)("AND")]))),_:1}),(0,o.bF)(U,{label:"OR"},{default:(0,o.k6)((()=>r[6]||(r[6]=[(0,o.eW)("OR")]))),_:1})])),_:2},1032,["modelValue","onUpdate:modelValue"])])):(0,o.Q3)("",!0),(0,o.Lk)("div",m,[(0,o.bF)(K,{gutter:10,align:"middle"},{default:(0,o.k6)((()=>[(0,o.bF)(x,{span:20},{default:(0,o.k6)((()=>[(0,o.bF)(V,{modelValue:e.type,"onUpdate:modelValue":l=>e.type=l,placeholder:"条件类型",size:"small",style:{"margin-bottom":"5px",width:"150px"}},{default:(0,o.k6)((()=>[(0,o.bF)(O,{label:"字段比较",value:"comparison"}),(0,o.bF)(O,{label:"计算比较",value:"calculation"})])),_:2},1032,["modelValue","onUpdate:modelValue"]),"comparison"===e.type?((0,o.uX)(),(0,o.CE)("div",v,[(0,o.bF)(V,{modelValue:e.leftOperand.field,"onUpdate:modelValue":l=>e.leftOperand.field=l,placeholder:"选择字段",size:"small",clearable:"",filterable:"",disabled:!F.sourceTable,style:{width:"160px"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(R(F.sourceTable),(e=>((0,o.uX)(),(0,o.Wv)(O,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),(0,o.bF)(V,{modelValue:e.operator,"onUpdate:modelValue":l=>e.operator=l,placeholder:"比较符",size:"small",style:{width:"100px"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(T.value,(e=>((0,o.uX)(),(0,o.Wv)(O,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue"]),E(e.operator)?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)(o.FK,{key:0},[(0,o.bF)(V,{modelValue:e.rightOperand.type,"onUpdate:modelValue":l=>e.rightOperand.type=l,placeholder:"类型",size:"small",style:{width:"70px"},onChange:l=>e.rightOperand.value=null},{default:(0,o.k6)((()=>[(0,o.bF)(O,{label:"字段",value:"field"}),(0,o.bF)(O,{label:"常量",value:"constant"})])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),"field"===e.rightOperand.type?((0,o.uX)(),(0,o.Wv)(V,{key:0,modelValue:e.rightOperand.value,"onUpdate:modelValue":l=>e.rightOperand.value=l,placeholder:"选择字段",size:"small",clearable:"",filterable:"",disabled:!F.sourceTable,style:{width:"160px"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(R(F.sourceTable),(e=>((0,o.uX)(),(0,o.Wv)(O,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])):((0,o.uX)(),(0,o.Wv)(d,{key:1,modelValue:e.rightOperand.value,"onUpdate:modelValue":l=>e.rightOperand.value=l,placeholder:"输入常量值",size:"small",clearable:"",style:{width:"160px"}},null,8,["modelValue","onUpdate:modelValue"]))],64))])):"calculation"===e.type?((0,o.uX)(),(0,o.CE)("div",f,[(0,o.bF)(V,{modelValue:e.fieldA,"onUpdate:modelValue":l=>e.fieldA=l,placeholder:"字段A",size:"small",clearable:"",filterable:"",disabled:!F.sourceTable,style:{width:"130px"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(W(F.sourceTable),(e=>((0,o.uX)(),(0,o.Wv)(O,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),(0,o.bF)(V,{modelValue:e.calcOperator,"onUpdate:modelValue":l=>e.calcOperator=l,placeholder:"算术符",size:"small",style:{width:"60px"}},{default:(0,o.k6)((()=>[(0,o.bF)(O,{label:"-",value:"-"})])),_:2},1032,["modelValue","onUpdate:modelValue"]),(0,o.bF)(V,{modelValue:e.fieldB,"onUpdate:modelValue":l=>e.fieldB=l,placeholder:"字段B",size:"small",clearable:"",filterable:"",disabled:!F.sourceTable,style:{width:"130px"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(W(F.sourceTable),(e=>((0,o.uX)(),(0,o.Wv)(O,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),(0,o.bF)(V,{modelValue:e.comparisonOperator,"onUpdate:modelValue":l=>e.comparisonOperator=l,placeholder:"比较符",size:"small",style:{width:"80px"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)($.value,(e=>((0,o.uX)(),(0,o.Wv)(O,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue"]),(0,o.bF)(d,{modelValue:e.constantValue,"onUpdate:modelValue":l=>e.constantValue=l,placeholder:"常量值",size:"small",clearable:"",style:{width:"100px"}},null,8,["modelValue","onUpdate:modelValue"])])):(0,o.Q3)("",!0)])),_:2},1024),(0,o.bF)(x,{span:4,style:{"text-align":"right"}},{default:(0,o.k6)((()=>[(0,o.bF)(i,{type:"danger",icon:(0,n.R1)(u.epd),circle:"",plain:"",size:"small",onClick:e=>I(l),disabled:F.logic.conditions.length<=1},null,8,["icon","onClick","disabled"])])),_:2},1024)])),_:2},1024)])])))),128)),(0,o.bF)(i,{type:"primary",link:"",icon:(0,n.R1)(u.FWt),onClick:B,style:{"margin-top":"10px"}},{default:(0,o.k6)((()=>r[7]||(r[7]=[(0,o.eW)("添加条件")]))),_:1},8,["icon"])])])),_:1}),(0,o.bF)(y,{label:"扣分分值",prop:"deductionPoints"},{default:(0,o.k6)((()=>[(0,o.bF)(N,{modelValue:F.deductionPoints,"onUpdate:modelValue":r[2]||(r[2]=e=>F.deductionPoints=e),min:0,step:1,"controls-position":"right",placeholder:"规则触发时扣除的分数",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,o.bF)(y,{label:"规则描述 (可选)"},{default:(0,o.k6)((()=>[(0,o.bF)(d,{type:"textarea",modelValue:F.description,"onUpdate:modelValue":r[3]||(r[3]=e=>F.description=e),placeholder:"简要说明规则的用途"},null,8,["modelValue"])])),_:1}),(0,o.bF)(y,null,{default:(0,o.k6)((()=>[(0,o.bF)(i,{type:"primary",onClick:j,loading:h.value},{default:(0,o.k6)((()=>[(0,o.eW)((0,t.v_)(a.value?"更新规则":"创建规则"),1)])),_:1},8,["loading"]),(0,o.bF)(i,{onClick:L},{default:(0,o.k6)((()=>r[8]||(r[8]=[(0,o.eW)("重置")]))),_:1})])),_:1})])),_:1},8,["model","rules"])])),_:1})])),_:1}),(0,o.bF)(x,{span:14},{default:(0,o.k6)((()=>[(0,o.bF)(q,null,{header:(0,o.k6)((()=>r[9]||(r[9]=[(0,o.Lk)("div",{class:"card-header"},[(0,o.Lk)("span",null,"已配置的字段规则")],-1)]))),default:(0,o.k6)((()=>[(0,o.bo)(((0,o.uX)(),(0,o.Wv)(M,{data:A.value,style:{width:"100%"},border:"",height:"500px"},{default:(0,o.k6)((()=>[(0,o.bF)(H,{prop:"name",label:"规则名称",width:"180","show-overflow-tooltip":""}),(0,o.bF)(H,{label:"规则逻辑","min-width":"300"},{default:(0,o.k6)((e=>[(0,o.Lk)("div",{innerHTML:P(e.row.logic,e.row.sourceTable)},null,8,g)])),_:1}),(0,o.bF)(H,{prop:"deductionPoints",label:"扣分分值",width:"100",align:"center"},{default:(0,o.k6)((e=>[(0,o.Lk)("span",k,"-"+(0,t.v_)(e.row.deductionPoints||0),1)])),_:1}),(0,o.bF)(H,{prop:"description",label:"描述","show-overflow-tooltip":""}),(0,o.bF)(H,{label:"操作",width:"150",align:"center"},{default:(0,o.k6)((e=>[(0,o.bF)(i,{size:"small",type:"primary",onClick:l=>S(e.row)},{default:(0,o.k6)((()=>r[10]||(r[10]=[(0,o.eW)("编辑")]))),_:2},1032,["onClick"]),(0,o.bF)(i,{size:"small",type:"danger",onClick:l=>Q(e.row.id)},{default:(0,o.k6)((()=>r[11]||(r[11]=[(0,o.eW)("删除")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[Y,_.value]])])),_:1})])),_:1})])),_:1})])}}};var h=a(6262);const _=(0,h.A)(y,[["__scopeId","data-v-524b08dc"]]),O=_}}]);
//# sourceMappingURL=7642.00fae2af.js.map