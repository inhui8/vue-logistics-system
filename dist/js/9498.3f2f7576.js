"use strict";(self["webpackChunkvue_logistics_system"]=self["webpackChunkvue_logistics_system"]||[]).push([[9498],{9498:(e,l,a)=>{a.r(l),a.d(l,{default:()=>z});var t=a(641),o=a(953),n=a(33),u=a(3751),i=a(5220),s=a(163),r=a(562),c=a(1857),d=a(5703),k=a(1361),v=a(2085),p=a(8224),g=a(3022),L=a(8548);const R={class:"stocking-view-wrapper"},f={class:"phone-mockup"},m={class:"phone-screen"},b={class:"stocking-confirm-container-el"},h={class:"train-info-el"},C={key:0,class:"confirm-button-container-el"},y={key:1,class:"order-data-area-el"},_={key:0,class:"loading-el"},F={class:"order-details-el"},w={key:0,class:"scan-actions-el"},W={key:1,class:"stocked-indicator-el"},S={key:1,class:"no-data-el"},E={class:"dialog-footer"},K={key:2,class:"footer-button-inside-phone"},U={class:"photo-upload-container"},X={key:0,class:"photo-placeholder"},O={key:1,class:"photo-preview"},V=["src"],j=["onClick"],$={class:"upload-actions"},D={class:"dialog-footer"},I={key:0,class:"camera-container"},T={class:"camera-actions"},N={key:1,class:"camera-error"},P={__name:"StockingConfirm",setup(e){const l=(0,i.lq)(),a=(0,i.rd)(),P=(0,o.KR)(null),Q=(0,o.KR)(null),B=(0,o.KR)(!1),z=(0,o.Kh)([]),A=(0,o.KR)(!1),M=(0,o.KR)(!1),Y=(0,o.KR)(""),Z=(0,o.KR)(null),q=(0,o.KR)(null),x=(0,o.KR)(""),H=(0,o.KR)(null),G=(0,o.KR)(!1),J=(0,o.KR)(!1),ee=(0,o.KR)([]),le=(0,o.KR)(!0),ae=(0,o.KR)(null),te=(0,o.KR)(null);let oe=null;(0,t.sV)((()=>{P.value=l.params.trainId,Q.value=l.params.trainNumber,P.value&&Q.value||s.nk.error("无效的车次信息")}));const ne=()=>{a.back()},ue=()=>{console.log(`开始为车次 ${Q.value} (ID: ${P.value}) 进行备货`),B.value=!0,z.length=0,ie()},ie=async()=>{A.value=!0,console.log("正在获取订单数据...");try{await new Promise((e=>setTimeout(e,500)));const e=[{palletCode:"PLT001",orderNumber:"ORD1001",originalLocation:"A1-01",targetLocation:"B2-05",status:"stocked"},{palletCode:"PLT002",orderNumber:"ORD1002",originalLocation:"A1-02",targetLocation:"B2-06",status:"pending"},{palletCode:"PLT003",orderNumber:"ORD1003",originalLocation:"C3-10",targetLocation:"D4-11",status:"pending"},{palletCode:"PLT004",orderNumber:"ORD1004",originalLocation:"C3-11",targetLocation:"D4-12",status:"pending"},{palletCode:"PLT005",orderNumber:"ORD1005",originalLocation:"E5-20",targetLocation:"F6-21",status:"pending"}],l=e.map((e=>({...e,palletScanned:!1,originalLocationScanned:!1,targetLocationScanned:!1})));z.push(...l)}catch(e){console.error("Failed to fetch order list:",e),s.nk.error("加载订单失败")}finally{A.value=!1}},se=e=>"pending"===e?"待备货":"已备货",re=()=>{M.value=!0,(0,t.dY)((()=>{H.value?.focus()}))},ce=e=>{Z.value="pallet",q.value=e,x.value=e.palletCode,Y.value="",re()},de=e=>{e.palletScanned?(Z.value="originalLocation",q.value=e,x.value=e.originalLocation,Y.value="",re()):s.nk.warning("请先扫描卡板")},ke=e=>{e.originalLocationScanned?(Z.value="targetLocation",q.value=e,x.value=e.targetLocation,Y.value="",re()):s.nk.warning("请先扫描原库位")},ve=()=>{if(!q.value||!Z.value)return;const e=q.value,l=Y.value.trim();if(!l)return void s.nk.warning("请输入扫描码");console.log(`模拟扫描 ${Z.value}: ${l}`);let a=!1;"pallet"===Z.value?l===e.palletCode?(e.palletScanned=!0,s.nk.success("卡板扫描成功"),a=!0):s.nk.error("卡板码不匹配"):"originalLocation"===Z.value?l===e.originalLocation?(e.originalLocationScanned=!0,s.nk.success("原库位扫描成功"),a=!0):s.nk.error("原库位码不匹配"):"targetLocation"===Z.value&&(l===e.targetLocation?(e.targetLocationScanned=!0,e.status="stocked",s.nk.success("新库位扫描成功，备货完成"),a=!0):s.nk.error("新库位码不匹配")),a?M.value=!1:(0,t.dY)((()=>{H.value?.select()}))},pe=()=>{Y.value=""},ge=((0,t.EW)((()=>0!==z.length&&z.every((e=>"stocked"===e.status)))),()=>{G.value=!0}),Le=e=>{if(!e)return;if(!e.raw.type.startsWith("image/"))return void s.nk.error("请上传图片文件");if(e.size/1024/1024>5)return void s.nk.error("图片大小不能超过5MB");const l=URL.createObjectURL(e.raw);ee.value.push({file:e.raw,url:l})},Re=e=>{URL.revokeObjectURL(ee.value[e].url),ee.value.splice(e,1)},fe=async()=>{J.value=!0,(0,t.dY)((()=>{me()}))},me=async()=>{try{oe=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}),ae.value&&(ae.value.srcObject=oe,le.value=!0)}catch(e){console.error("无法访问摄像头:",e),le.value=!1,s.nk.error("无法访问摄像头，请检查浏览器权限设置")}},be=()=>{if(!ae.value||!oe)return;const e=document.createElement("canvas"),l=e.getContext("2d"),a=ae.value;e.width=a.videoWidth,e.height=a.videoHeight,l.drawImage(a,0,0,e.width,e.height),e.toBlob((e=>{const l=URL.createObjectURL(e);ee.value.push({file:new File([e],`photo_${Date.now()}.jpg`,{type:"image/jpeg"}),url:l}),he()}),"image/jpeg",.95)},he=()=>{J.value=!1,oe&&(oe.getTracks().forEach((e=>e.stop())),oe=null)},Ce=()=>{ee.value.forEach((e=>{URL.revokeObjectURL(e.url)})),ee.value=[],G.value=!1},ye=()=>{ee.value.length?(s.nk.success({message:`成功上传了 ${ee.value.length} 张凭证照片`,duration:2e3}),setTimeout((()=>{ee.value.forEach((e=>{URL.revokeObjectURL(e.url)})),ee.value=[],G.value=!1,s.nk.success({message:`车次 ${Q.value} 备货完成!`,duration:2e3})}),1e3)):s.nk.warning("请至少上传一张凭证照片")};return(0,t.hi)((()=>{oe&&oe.getTracks().forEach((e=>e.stop())),ee.value.forEach((e=>{URL.revokeObjectURL(e.url)}))})),(e,l)=>((0,t.uX)(),(0,t.CE)("div",R,[(0,t.Lk)("div",f,[(0,t.Lk)("div",m,[(0,t.Lk)("div",b,[(0,t.bF)((0,o.R1)(r.IO),{onBack:ne,content:"确认备货"}),(0,t.Lk)("div",h,[(0,t.Lk)("h2",null,"车次号: "+(0,n.v_)(Q.value),1)]),B.value?(0,t.Q3)("",!0):((0,t.uX)(),(0,t.CE)("div",C,[(0,t.bF)((0,o.R1)(c.S2),{type:"primary",onClick:ue,style:{width:"100%"}},{default:(0,t.k6)((()=>l[6]||(l[6]=[(0,t.eW)("确认备货开始")]))),_:1})])),B.value?((0,t.uX)(),(0,t.CE)("div",y,[A.value?((0,t.uX)(),(0,t.CE)("p",_,"加载订单中...")):(0,t.Q3)("",!0),((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(z,(e=>((0,t.uX)(),(0,t.Wv)((0,o.R1)(d.Ik),{shadow:"never",key:e.palletCode,class:(0,n.C4)(["order-card-el",{"stocked-el":"stocked"===e.status}])},{default:(0,t.k6)((()=>[(0,t.Lk)("div",F,[(0,t.Lk)("p",null,[l[7]||(l[7]=(0,t.Lk)("strong",null,"卡板号:",-1)),(0,t.eW)(" "+(0,n.v_)(e.palletCode),1)]),(0,t.Lk)("p",null,[l[8]||(l[8]=(0,t.Lk)("strong",null,"PC号:",-1)),(0,t.eW)(" "+(0,n.v_)(e.orderNumber),1)]),(0,t.Lk)("p",null,[l[9]||(l[9]=(0,t.Lk)("strong",null,"原库位:",-1)),(0,t.eW)(" "+(0,n.v_)(e.originalLocation),1)]),(0,t.Lk)("p",null,[l[10]||(l[10]=(0,t.Lk)("strong",null,"指定库位:",-1)),(0,t.eW)(" "+(0,n.v_)(e.targetLocation),1)]),(0,t.Lk)("p",null,[l[11]||(l[11]=(0,t.Lk)("strong",null,"状态:",-1)),l[12]||(l[12]=(0,t.eW)()),(0,t.Lk)("span",{class:(0,n.C4)(`status-${e.status}-el`)},(0,n.v_)(se(e.status)),3)])]),"pending"===e.status?((0,t.uX)(),(0,t.CE)("div",w,[(0,t.bF)((0,o.R1)(c.S2),{size:"small",type:"primary",onClick:l=>ce(e),plain:""},{default:(0,t.k6)((()=>l[13]||(l[13]=[(0,t.eW)("扫卡板")]))),_:2},1032,["onClick"]),(0,t.bF)((0,o.R1)(c.S2),{size:"small",type:"warning",onClick:l=>de(e),disabled:!e.palletScanned,plain:""},{default:(0,t.k6)((()=>l[14]||(l[14]=[(0,t.eW)("扫原库位")]))),_:2},1032,["onClick","disabled"]),(0,t.bF)((0,o.R1)(c.S2),{size:"small",type:"success",onClick:l=>ke(e),disabled:!e.originalLocationScanned,plain:""},{default:(0,t.k6)((()=>l[15]||(l[15]=[(0,t.eW)("扫新库位")]))),_:2},1032,["onClick","disabled"])])):(0,t.Q3)("",!0),"stocked"===e.status?((0,t.uX)(),(0,t.CE)("div",W,[(0,t.bF)((0,o.R1)(k.tk),{color:"#67C23A",size:"18"},{default:(0,t.k6)((()=>[(0,t.bF)((0,o.R1)(L.m6F))])),_:1}),l[16]||(l[16]=(0,t.eW)(" 已备货 "))])):(0,t.Q3)("",!0)])),_:2},1032,["class"])))),128)),z.length||A.value?(0,t.Q3)("",!0):((0,t.uX)(),(0,t.CE)("p",S,"没有需要备货的订单"))])):(0,t.Q3)("",!0),(0,t.bF)((0,o.R1)(v.kZ),{modelValue:M.value,"onUpdate:modelValue":l[2]||(l[2]=e=>M.value=e),title:`扫描${"pallet"===Z.value?"卡板":"originalLocation"===Z.value?"原库位":"新库位"}: ${x.value}`,width:"90%","append-to-body":!0,"close-on-click-modal":!1,onClosed:pe},{footer:(0,t.k6)((()=>[(0,t.Lk)("span",E,[(0,t.bF)((0,o.R1)(c.S2),{onClick:l[1]||(l[1]=e=>M.value=!1)},{default:(0,t.k6)((()=>l[17]||(l[17]=[(0,t.eW)("取消")]))),_:1}),(0,t.bF)((0,o.R1)(c.S2),{type:"primary",onClick:ve},{default:(0,t.k6)((()=>l[18]||(l[18]=[(0,t.eW)("确认")]))),_:1})])])),default:(0,t.k6)((()=>[(0,t.bF)((0,o.R1)(p.WK),{modelValue:Y.value,"onUpdate:modelValue":l[0]||(l[0]=e=>Y.value=e),placeholder:`请输入模拟 ${"pallet"===Z.value?"卡板":"originalLocation"===Z.value?"原库位":"新库位"} 码`,clearable:"",onKeyup:(0,u.jR)(ve,["enter"]),ref_key:"scanInputRef",ref:H},null,8,["modelValue","placeholder"])])),_:1},8,["modelValue","title"]),B.value?((0,t.uX)(),(0,t.CE)("div",K,[(0,t.bF)((0,o.R1)(c.S2),{type:"success",onClick:ge,style:{width:"100%"}},{default:(0,t.k6)((()=>l[19]||(l[19]=[(0,t.eW)("备货完成")]))),_:1})])):(0,t.Q3)("",!0)]),(0,t.bF)((0,o.R1)(v.kZ),{modelValue:G.value,"onUpdate:modelValue":l[3]||(l[3]=e=>G.value=e),title:"上传凭证照片",width:"90%","append-to-body":!0,"close-on-click-modal":!1,"show-close":!1},{footer:(0,t.k6)((()=>[(0,t.Lk)("span",D,[(0,t.bF)((0,o.R1)(c.S2),{onClick:Ce},{default:(0,t.k6)((()=>l[23]||(l[23]=[(0,t.eW)("取消")]))),_:1}),(0,t.bF)((0,o.R1)(c.S2),{type:"primary",onClick:ye,disabled:!ee.value.length},{default:(0,t.k6)((()=>l[24]||(l[24]=[(0,t.eW)("提交")]))),_:1},8,["disabled"])])])),default:(0,t.k6)((()=>[(0,t.Lk)("div",U,[ee.value.length?((0,t.uX)(),(0,t.CE)("div",O,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(ee.value,((e,l)=>((0,t.uX)(),(0,t.CE)("div",{key:l,class:"photo-item"},[(0,t.Lk)("img",{src:e.url,alt:"凭证照片"},null,8,V),(0,t.Lk)("div",{class:"photo-delete",onClick:e=>Re(l)},[(0,t.bF)((0,o.R1)(k.tk),null,{default:(0,t.k6)((()=>[(0,t.bF)((0,o.R1)(L.epd))])),_:1})],8,j)])))),128))])):((0,t.uX)(),(0,t.CE)("div",X,[(0,t.bF)((0,o.R1)(k.tk),null,{default:(0,t.k6)((()=>[(0,t.bF)((0,o.R1)(L.VIg))])),_:1}),l[20]||(l[20]=(0,t.Lk)("p",null,"请上传凭证照片",-1))])),(0,t.Lk)("div",$,[(0,t.bF)((0,o.R1)(g.j5),{ref_key:"uploadRef",ref:te,"auto-upload":!1,"show-file-list":!1,"on-change":Le,multiple:!0,accept:"image/*"},{default:(0,t.k6)((()=>[(0,t.bF)((0,o.R1)(c.S2),{type:"primary",plain:""},{default:(0,t.k6)((()=>[(0,t.bF)((0,o.R1)(k.tk),null,{default:(0,t.k6)((()=>[(0,t.bF)((0,o.R1)(L._OO))])),_:1}),l[21]||(l[21]=(0,t.eW)(" 选择照片 "))])),_:1})])),_:1},512),(0,t.bF)((0,o.R1)(c.S2),{type:"success",onClick:fe,plain:""},{default:(0,t.k6)((()=>[(0,t.bF)((0,o.R1)(k.tk),null,{default:(0,t.k6)((()=>[(0,t.bF)((0,o.R1)(L.i7d))])),_:1}),l[22]||(l[22]=(0,t.eW)(" 拍照 "))])),_:1})])])])),_:1},8,["modelValue"]),(0,t.bF)((0,o.R1)(v.kZ),{modelValue:J.value,"onUpdate:modelValue":l[5]||(l[5]=e=>J.value=e),title:"拍摄凭证照片",width:"90%","append-to-body":!0,"close-on-click-modal":!1},{default:(0,t.k6)((()=>[le.value?((0,t.uX)(),(0,t.CE)("div",I,[(0,t.Lk)("video",{ref_key:"videoRef",ref:ae,autoplay:"",class:"camera-video"},null,512),(0,t.Lk)("div",T,[(0,t.bF)((0,o.R1)(c.S2),{type:"primary",onClick:be},{default:(0,t.k6)((()=>l[25]||(l[25]=[(0,t.eW)("拍照")]))),_:1}),(0,t.bF)((0,o.R1)(c.S2),{onClick:l[4]||(l[4]=e=>J.value=!1)},{default:(0,t.k6)((()=>l[26]||(l[26]=[(0,t.eW)("取消")]))),_:1})])])):((0,t.uX)(),(0,t.CE)("div",N,[(0,t.bF)((0,o.R1)(k.tk),null,{default:(0,t.k6)((()=>[(0,t.bF)((0,o.R1)(L.BFW))])),_:1}),l[27]||(l[27]=(0,t.Lk)("p",null,"无法访问摄像头，请检查权限或使用上传功能",-1))]))])),_:1},8,["modelValue"])])])]))}};var Q=a(6262);const B=(0,Q.A)(P,[["__scopeId","data-v-5dbf0c78"]]),z=B}}]);
//# sourceMappingURL=9498.3f2f7576.js.map